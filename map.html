<!DOCTYPE html>
<html>
  <head>
    <title>Saskatoon Transit - Where Are The Buses?</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="jquery.easing.1.3.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marker-animate-unobtrusive/0.2.8/vendor/markerAnimate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marker-animate-unobtrusive/0.2.8/SlidingMarker.min.js"></script>
    <script>
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 52.133214, lng: -106.670046 },
          zoom: 13
        });
        var markers = {};
        var lines = {};

        var updatePositions = function() {
          $.ajax({
            url: "vehicle_positions.json",
            dataType: "json",
            context: document.body,
            success: function(vehicles) {
              for (var vehicleId in markers) {
                markers[vehicleId]._alive = false;
              }

              for (var vehicleId in vehicles) {
                var vehicle = vehicles[vehicleId][0];
                var position = new google.maps.LatLng(vehicle.latitude, vehicle.longitude);
                var age = Math.round(+(new Date())/1000 - vehicle.timestamp);
                var route = vehicle.route === null ? '?' : vehicle.route.headsign;
                if (markers[vehicleId]) {
                  markers[vehicleId].setPosition(position);
                  markers[vehicleId].setLabel(route);
                  markers[vehicleId].setTitle(age + ' seconds ago');
                  markers[vehicleId]._alive = true;
                } else {
                  var marker = new SlidingMarker({
                    label: route,
                    title: age + ' seconds ago',
                    position: position
                  });
                  marker.setMap(map);
                  markers[vehicleId] = marker;
                  markers[vehicleId]._alive = true;
                }
              }

              for (var vehicleId in markers) {
                if (!markers[vehicleId]._alive) {
                  markers[vehicleId].setMap(null);
                  delete markers[vehicleId];
                }
              }

              setTimeout(function () {
                for (var vehicleId in vehicles) {
                  if (vehicles[vehicleId].length > 1) {
                    var busPath = [];
                    vehicles[vehicleId].forEach(function (position) {
                      busPath.push({ lat: position.latitude, lng: position.longitude });
                    });

                    var line = new google.maps.Polyline({
                      path: busPath,
                      strokeColor: '#FF00FF',
                      strokeOpacity: 1.0,
                      strokeWeight: 1.5
                    });
                    if (lines[vehicleId]) {
                      lines[vehicleId].setMap(null);
                    }
                    line.setMap(map);
                    lines[vehicleId] = line;
                  }
                }
              }, 500);
            }
          });
        };

        updatePositions();
        setInterval(updatePositions, 5000);
      }
      initMap();
    </script>
  </body>
</html>
